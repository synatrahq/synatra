---
import { PhSparkle, PhGear, PhCaretDown, PhClock } from "phosphor-icons-astro"
import postgresIcon from "../../assets/postgres.svg"
import mysqlIcon from "../../assets/mysql.svg"
import stripeIcon from "../../assets/stripe.svg"
import githubIcon from "../../assets/github_dark.svg"
import intercomIcon from "../../assets/intercom_dark.svg"
---

<section id="how-it-works-section" class="border-t border-surface-border-muted px-6 py-24 grid-dots">
  <div class="mx-auto max-w-5xl">
    <p class="text-xs font-medium text-gray-500">Your turn</p>
    <h2 class="mt-4 max-w-2xl text-2xl font-semibold tracking-tight text-white md:text-3xl">
      Build agents in minutes
    </h2>
    <p class="mt-4 max-w-2xl text-sm text-gray-400">
      Chat with Copilot, it writes the agent. Pure JavaScript you can read, edit, and extend.
    </p>

    <div class="mt-16">
      <div class="space-y-16 lg:space-y-20">
        <div class="step-container relative grid gap-8 lg:grid-cols-2 lg:items-start" data-step="copilot">
          <div class="absolute left-[11px] top-8 bottom-0 w-px bg-gradient-to-b from-emerald-500/50 to-emerald-500/10 hidden lg:block"></div>
          <div class="relative lg:pl-12">
            <div class="inline-flex items-center gap-2 lg:hidden rounded-full bg-surface-border/50 px-3 py-1 text-xs font-medium text-gray-300 mb-3">
              <span class="flex h-5 w-5 items-center justify-center rounded-full bg-emerald-500/20 text-[10px] font-bold text-emerald-400">1</span>
              Just ask
            </div>
            <div class="hidden lg:flex items-center gap-3">
              <div class="absolute left-0 flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500/20 border border-emerald-500/30">
                <span class="text-[10px] font-bold text-emerald-400">1</span>
              </div>
              <p class="text-xs font-medium text-emerald-400">Just ask</p>
            </div>
            <h3 class="mt-1 text-xl font-medium text-white">Describe what you need</h3>
            <p class="mt-3 text-sm text-gray-400 leading-relaxed">
              Talk to Copilot like a colleague. It understands your intent, proposes changes, and generates tools in real-time. Review the diff, then apply or reject—you're always in control.
            </p>
          </div>
          <div id="copilot-demo" class="copilot-demo rounded-xl border border-surface-border-muted bg-surface-bg-muted overflow-hidden min-h-[260px]">
            <div class="flex items-center gap-2 border-b border-surface-border-muted bg-surface-bg-muted px-4 py-2.5">
              <div class="flex h-5 w-5 items-center justify-center rounded-full bg-emerald-500/20">
                <PhSparkle class="h-3 w-3 text-emerald-400" />
              </div>
              <span class="text-xs font-medium text-white">Copilot</span>
              <div class="copilot-progress ml-auto flex items-center gap-2" data-stage="idle">
                <div class="copilot-progress-bar h-1 w-12 rounded-full bg-surface-border overflow-hidden">
                  <div class="copilot-progress-fill h-full w-0 rounded-full transition-all duration-500"></div>
                </div>
                <span class="copilot-status rounded px-2 py-0.5 text-[10px] transition-all duration-300">Idle</span>
              </div>
            </div>
            <div class="p-4 space-y-3">
              <div class="copilot-msg flex gap-3" data-step="0">
                <div class="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-gray-700 text-[10px] font-medium">You</div>
                <div class="rounded-lg bg-surface-border px-3">
                  <p class="copilot-user-msg text-xs text-gray-300"></p>
                </div>
              </div>
              <div class="copilot-msg flex gap-3" data-step="1">
                <div class="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-emerald-500/20"><PhSparkle class="h-3 w-3 text-emerald-400" /></div>
                <div class="flex-1 space-y-2">
                  <p class="copilot-response text-xs text-gray-400"></p>
                  <div class="copilot-msg copilot-tool-box rounded-lg border border-emerald-500/30 bg-emerald-950/20 p-3 space-y-2" data-step="2">
                    <div class="flex items-center justify-between">
                      <span class="text-[10px] font-medium text-emerald-400">Proposed changes</span>
                      <div class="copilot-buttons flex gap-1.5">
                        <button class="copilot-apply rounded bg-emerald-600 px-2 py-0.5 text-[10px] font-medium text-white transition-all">Apply</button>
                        <button class="rounded border border-surface-border px-2 py-0.5 text-[10px] text-gray-400">Reject</button>
                      </div>
                    </div>
                    <div class="space-y-1 text-[11px]">
                      <div class="copilot-tool flex items-center gap-2 text-gray-300" data-tool="0"><span class="text-emerald-400">+</span> <span class="tool-name"></span></div>
                      <div class="copilot-tool flex items-center gap-2 text-gray-300" data-tool="1"><span class="text-emerald-400">+</span> <span class="tool-name"></span></div>
                      <div class="copilot-tool flex items-center gap-2 text-gray-300" data-tool="2"><span class="text-emerald-400">+</span> <span class="tool-name"></span></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="step-container step-animate relative grid gap-8 lg:grid-cols-2 lg:items-start" data-step="code">
          <div class="absolute left-[11px] top-8 bottom-0 w-px bg-gradient-to-b from-blue-500/50 to-blue-500/10 hidden lg:block"></div>
          <div class="relative lg:pl-12">
            <div class="inline-flex items-center gap-2 lg:hidden rounded-full bg-surface-border/50 px-3 py-1 text-xs font-medium text-gray-300 mb-3">
              <span class="flex h-5 w-5 items-center justify-center rounded-full bg-blue-500/20 text-[10px] font-bold text-blue-400">2</span>
              Give it superpowers
            </div>
            <div class="hidden lg:flex items-center gap-3">
              <div class="absolute left-0 flex h-6 w-6 items-center justify-center rounded-full bg-blue-500/20 border border-blue-500/30">
                <span class="text-[10px] font-bold text-blue-400">2</span>
              </div>
              <p class="text-xs font-medium text-blue-400">Give it superpowers</p>
            </div>
            <h3 class="mt-1 text-xl font-medium text-white">Readable, editable code</h3>
            <p class="mt-3 text-sm text-gray-400 leading-relaxed">
              Every tool is a JavaScript function with typed params and returns. Use <code class="rounded bg-surface-border px-1 py-0.5 text-[11px] text-blue-300">context.resources</code> to query Postgres, call Stripe, and more.
            </p>
            <div class="mt-4 flex flex-wrap items-center gap-3 resource-icons">
              <img src={postgresIcon.src} alt="Postgres" class="resource-icon h-5 w-5 opacity-60 transition-all duration-300" />
              <img src={mysqlIcon.src} alt="MySQL" class="resource-icon h-5 w-5 opacity-60 transition-all duration-300" />
              <img src={stripeIcon.src} alt="Stripe" class="resource-icon h-5 w-5 opacity-60 transition-all duration-300" data-resource="stripe" />
              <img src={githubIcon.src} alt="GitHub" class="resource-icon h-5 w-5 opacity-60 transition-all duration-300" />
              <img src={intercomIcon.src} alt="Intercom" class="resource-icon h-5 w-5 opacity-60 transition-all duration-300" />
            </div>
          </div>
          <div id="code-demo" class="code-demo overflow-hidden rounded-xl border border-surface-border-muted bg-surface-bg-muted">
            <div class="flex items-center gap-2 border-b border-surface-border-muted bg-surface-bg-muted px-4 py-2.5">
              <div class="flex gap-1">
                <div class="h-2.5 w-2.5 rounded-full bg-red-500/60"></div>
                <div class="h-2.5 w-2.5 rounded-full bg-yellow-500/60"></div>
                <div class="h-2.5 w-2.5 rounded-full bg-green-500/60"></div>
              </div>
              <span class="ml-2 text-xs text-gray-500">getFailedPayments.js</span>
              <span class="code-badge rounded bg-blue-500/20 px-1.5 py-0.5 text-[10px] text-blue-400 transition-all duration-300">Tool</span>
            </div>
            <pre class="overflow-x-auto p-4 font-mono text-[11px] leading-relaxed"><code><span class="code-line" data-line="0"><span class="text-gray-500">// Params: {'{'} hours: number {'}'}</span></span><span class="code-line" data-line="1"><span class="text-gray-500">// Returns: {'{'} payments: Payment[] {'}'}</span></span><span class="code-line" data-line="2">&nbsp;</span><span class="code-line" data-line="3"><span class="text-purple-400">const</span> {'{'} <span class="text-white">hours</span> {'}'} = <span class="text-orange-300">params</span></span><span class="code-line" data-line="4" data-highlight="stripe"><span class="text-purple-400">const</span> <span class="text-white">stripe</span> = <span class="text-orange-300">context</span>.<span class="text-blue-300">resources</span>.<span class="text-yellow-300">stripe</span></span><span class="code-line" data-line="5">&nbsp;</span><span class="code-line" data-line="6"><span class="text-purple-400">const</span> <span class="text-white">payments</span> = <span class="text-purple-400">await</span> <span class="text-white">stripe</span>.<span class="text-yellow-300">paymentIntents</span>.<span class="text-yellow-300">list</span>({'{'}</span><span class="code-line" data-line="7">  <span class="text-gray-400">created:</span> {'{'} <span class="text-gray-400">gte:</span> <span class="text-white">Date</span>.<span class="text-yellow-300">now</span>() - <span class="text-white">hours</span> * <span class="text-amber-300">3600000</span> {'}'},</span><span class="code-line" data-line="8">  <span class="text-gray-400">limit:</span> <span class="text-amber-300">100</span></span><span class="code-line" data-line="9">{'}'})</span><span class="code-line" data-line="10">&nbsp;</span><span class="code-line" data-line="11"><span class="text-purple-400">const</span> <span class="text-white">failed</span> = <span class="text-white">payments</span>.<span class="text-blue-300">data</span>.<span class="text-yellow-300">filter</span>(</span><span class="code-line" data-line="12">  <span class="text-white">p</span> =&gt; <span class="text-white">p</span>.<span class="text-blue-300">status</span> === <span class="text-amber-300">"requires_payment_method"</span></span><span class="code-line" data-line="13">)</span><span class="code-line" data-line="14">&nbsp;</span><span class="code-line" data-line="15"><span class="text-purple-400">return</span> {'{'} <span class="text-gray-400">payments:</span> <span class="text-white">failed</span> {'}'}</span></code></pre>
          </div>
        </div>

        <div class="step-container step-animate relative grid gap-8 lg:grid-cols-2 lg:items-start" data-step="settings">
          <div class="absolute left-[11px] top-8 bottom-0 w-px bg-gradient-to-b from-amber-500/50 to-amber-500/10 hidden lg:block"></div>
          <div class="relative lg:pl-12">
            <div class="inline-flex items-center gap-2 lg:hidden rounded-full bg-surface-border/50 px-3 py-1 text-xs font-medium text-gray-300 mb-3">
              <span class="flex h-5 w-5 items-center justify-center rounded-full bg-amber-500/20 text-[10px] font-bold text-amber-400">3</span>
              Ship it
            </div>
            <div class="hidden lg:flex items-center gap-3">
              <div class="absolute left-0 flex h-6 w-6 items-center justify-center rounded-full bg-amber-500/20 border border-amber-500/30">
                <span class="text-[10px] font-bold text-amber-400">3</span>
              </div>
              <p class="text-xs font-medium text-amber-400">Ship it</p>
            </div>
            <h3 class="mt-1 text-xl font-medium text-white">Set the rules, let it work</h3>
            <p class="mt-3 text-sm text-gray-400 leading-relaxed">
              Choose your LLM (OpenAI, Anthropic, Google). Set which tools require human approval. Configure triggers—cron, webhooks, or events. One-click deploy with semantic versioning.
            </p>
          </div>
          <div id="settings-demo" class="settings-demo rounded-xl border border-surface-border-muted bg-surface-bg-muted overflow-hidden">
            <div class="flex items-center gap-2 border-b border-surface-border-muted bg-surface-bg-muted px-4 py-2.5">
              <PhGear class="h-3.5 w-3.5 text-gray-400" />
              <span class="text-xs font-medium text-white">Agent settings</span>
              <span class="ml-auto flex items-center gap-1.5">
                <span class="settings-version rounded bg-surface-border px-1.5 py-0.5 text-[10px] text-gray-400 transition-all duration-300">v1.2.0</span>
                <button class="settings-deploy rounded bg-emerald-600 px-2.5 py-1 text-[10px] font-medium text-white flex items-center gap-1 transition-all duration-300">
                  Deploy
                  <PhCaretDown class="h-2.5 w-2.5" />
                </button>
              </span>
            </div>
            <div class="p-4 space-y-4">
              <div class="settings-section space-y-2" data-section="model">
                <label class="text-[10px] font-medium text-gray-500 tracking-wider">Model</label>
                <div class="flex gap-2">
                  <button class="settings-model rounded-lg bg-blue-500/20 border border-blue-500/30 px-3 py-1.5 text-xs text-blue-300 transition-all duration-300" data-model="gpt" data-selected="true">GPT-4o</button>
                  <button class="settings-model rounded-lg bg-surface-border/50 border border-surface-border px-3 py-1.5 text-xs text-gray-400 transition-all duration-300" data-model="claude">Claude Sonnet</button>
                  <button class="settings-model rounded-lg bg-surface-border/50 border border-surface-border px-3 py-1.5 text-xs text-gray-400 transition-all duration-300" data-model="gemini">Gemini Pro</button>
                </div>
              </div>
              <div class="settings-section space-y-2" data-section="approval">
                <label class="text-[10px] font-medium text-gray-500 tracking-wider">Tools requiring approval</label>
                <div class="space-y-1.5">
                  <div class="settings-approval flex items-center justify-between rounded-lg bg-surface-bg-elevated/50 px-3 py-2 transition-all duration-300" data-tool="retry">
                    <span class="text-xs text-gray-300">retryPayment()</span>
                    <span class="settings-approval-badge rounded bg-amber-500/20 px-2 py-0.5 text-[10px] text-amber-400 transition-all duration-300">Owner only</span>
                  </div>
                  <div class="settings-approval flex items-center justify-between rounded-lg bg-surface-bg-elevated/50 px-3 py-2 transition-all duration-300" data-tool="notify">
                    <span class="text-xs text-gray-300">notifyTeam()</span>
                    <span class="settings-approval-badge rounded bg-gray-700 px-2 py-0.5 text-[10px] text-gray-400 transition-all duration-300">Auto-approve</span>
                  </div>
                </div>
              </div>
              <div class="settings-section space-y-2" data-section="trigger">
                <label class="text-[10px] font-medium text-gray-500 tracking-wider">Trigger</label>
                <div class="settings-trigger flex items-center gap-2 rounded-lg bg-surface-bg-elevated/50 px-3 py-2 transition-all duration-300">
                  <PhClock class="h-3.5 w-3.5 text-blue-400" />
                  <span class="text-xs text-gray-300">Every day at 9:00 AM</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .copilot-msg {
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.3s var(--ease-out), transform 0.3s var(--ease-out);
  }

  .copilot-msg.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .copilot-tool {
    opacity: 0;
    transform: translateX(-8px);
    transition: opacity 0.25s var(--ease-out), transform 0.25s var(--ease-out);
  }

  .copilot-tool.is-visible {
    opacity: 1;
    transform: translateX(0);
  }

  .copilot-tool.is-glowing {
    animation: tool-glow 0.6s var(--ease-out);
  }

  @keyframes tool-glow {
    0%, 100% { text-shadow: none; }
    50% { text-shadow: 0 0 8px rgb(16 185 129 / 0.8); }
  }

  .copilot-cursor {
    display: inline-block;
    width: 2px;
    height: 12px;
    background: currentColor;
    animation: copilot-blink 0.8s step-end infinite;
    vertical-align: text-bottom;
    margin-left: 1px;
  }

  @keyframes copilot-blink {
    50% { opacity: 0; }
  }

  @keyframes copilot-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgb(16 185 129 / 0.4); }
    50% { box-shadow: 0 0 0 4px rgb(16 185 129 / 0); }
  }

  .copilot-apply.is-ready {
    animation: copilot-pulse 1.5s ease-in-out infinite;
  }

  .copilot-progress-fill {
    background: linear-gradient(90deg, rgb(59 130 246), rgb(16 185 129));
  }

  .copilot-progress[data-stage="analyzing"] .copilot-progress-fill { width: 33%; }
  .copilot-progress[data-stage="generating"] .copilot-progress-fill { width: 66%; }
  .copilot-progress[data-stage="complete"] .copilot-progress-fill { width: 100%; }

  .copilot-status {
    background: rgb(55 65 81);
    color: rgb(156 163 175);
  }

  .copilot-progress[data-stage="analyzing"] .copilot-status {
    background: rgb(59 130 246 / 0.2);
    color: rgb(96 165 250);
  }

  .copilot-progress[data-stage="generating"] .copilot-status {
    background: rgb(16 185 129 / 0.2);
    color: rgb(52 211 153);
  }

  .copilot-progress[data-stage="complete"] .copilot-status {
    background: rgb(34 197 94 / 0.2);
    color: rgb(74 222 128);
  }

  .copilot-tool-box {
    transition: box-shadow 0.4s var(--ease-out), border-color 0.4s;
  }

  .copilot-tool-box.is-glowing {
    box-shadow: 0 0 20px rgb(16 185 129 / 0.3), 0 0 40px rgb(16 185 129 / 0.15);
    border-color: rgb(16 185 129 / 0.5);
  }

  .step-animate {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.5s var(--ease-out), transform 0.5s var(--ease-out);
  }

  .step-animate.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .code-line {
    display: block;
    opacity: 0;
    transform: translateX(-4px);
    transition: opacity 0.2s var(--ease-out), transform 0.2s var(--ease-out), background 0.3s, box-shadow 0.3s;
    padding-left: 4px;
    margin-left: -4px;
  }

  .code-line.is-visible {
    opacity: 1;
    transform: translateX(0);
  }

  .code-line.is-highlighting {
    background: rgb(59 130 246 / 0.1);
    box-shadow: -3px 0 0 rgb(59 130 246 / 0.6);
  }

  .resource-icon.is-active {
    opacity: 1;
    transform: scale(1.15);
    filter: drop-shadow(0 0 6px rgb(59 130 246 / 0.6));
  }

  .code-badge.is-glowing {
    background: rgb(59 130 246 / 0.3);
    box-shadow: 0 0 12px rgb(59 130 246 / 0.4);
  }

  .settings-model.is-switching {
    transform: scale(0.95);
  }

  .settings-model.is-selected {
    background: rgb(168 85 247 / 0.2) !important;
    border-color: rgb(168 85 247 / 0.4) !important;
    color: rgb(192 132 252) !important;
    box-shadow: 0 0 15px rgb(168 85 247 / 0.25);
  }

  .settings-approval.is-toggling {
    background: rgb(16 185 129 / 0.1);
  }

  .settings-approval-badge.is-changing {
    animation: badge-flip 0.4s var(--ease-smooth);
  }

  @keyframes badge-flip {
    0% { transform: rotateX(0deg); }
    50% { transform: rotateX(90deg); opacity: 0.5; }
    100% { transform: rotateX(0deg); }
  }

  .settings-deploy.is-ready {
    animation: deploy-pulse 2s ease-in-out infinite;
  }

  @keyframes deploy-pulse {
    0%, 100% {
      box-shadow: 0 0 0 0 rgb(16 185 129 / 0.5);
    }
    50% {
      box-shadow: 0 0 0 6px rgb(16 185 129 / 0);
      transform: translateY(-1px);
    }
  }

  .settings-version.is-bumped {
    background: rgb(16 185 129 / 0.2);
    color: rgb(52 211 153);
  }

  .settings-section {
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.3s var(--ease-out), transform 0.3s var(--ease-out);
  }

  .settings-section.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  @media (prefers-reduced-motion: reduce) {
    .copilot-msg,
    .copilot-tool,
    .step-animate,
    .code-line,
    .settings-section {
      opacity: 1;
      transform: none;
      transition: none;
    }
    .copilot-cursor {
      animation: none;
      opacity: 1;
    }
    .copilot-apply.is-ready,
    .settings-deploy.is-ready {
      animation: none;
    }
    .copilot-tool-box.is-glowing,
    .code-line.is-highlighting,
    .resource-icon.is-active,
    .code-badge.is-glowing,
    .settings-model.is-selected,
    .settings-approval.is-toggling {
      box-shadow: none;
      filter: none;
    }
  }
</style>

<script>
  const section = document.getElementById("how-it-works-section")
  const demo = document.getElementById("copilot-demo")
  const codeDemo = document.getElementById("code-demo")
  const settingsDemo = document.getElementById("settings-demo")

  if (section && !window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
    interface StepState {
      animating: boolean
      done: boolean
    }

    const state = new Map<string, StepState>()
    state.set("copilot", { animating: false, done: false })
    state.set("code", { animating: false, done: false })
    state.set("settings", { animating: false, done: false })

    const userMsg = "Every Monday I waste 30 mins finding failed payments. Automate this."
    const aiResponse = "Say less. Here's what I'm building:"
    const toolNames = ["getFailedPayments()", "retryPayment(paymentId)", "notifyTeam(message)"]

    const typeText = (el: HTMLElement, text: string, speed = 30): Promise<void> => {
      return new Promise((resolve) => {
        let i = 0
        el.innerHTML = '<span class="copilot-cursor"></span>'
        const type = () => {
          if (i < text.length) {
            el.innerHTML = text.slice(0, i + 1) + '<span class="copilot-cursor"></span>'
            i++
            setTimeout(type, speed + Math.random() * 5)
          } else {
            el.textContent = text
            resolve()
          }
        }
        type()
      })
    }

    const playCopilotDemo = async () => {
      if (!demo) return
      const s = state.get("copilot")!
      if (s.done || s.animating) return
      s.animating = true

      const userMsgEl = demo.querySelector(".copilot-user-msg") as HTMLElement
      const responseEl = demo.querySelector(".copilot-response") as HTMLElement
      const progressEl = demo.querySelector(".copilot-progress") as HTMLElement
      const statusEl = demo.querySelector(".copilot-status") as HTMLElement
      const toolBox = demo.querySelector(".copilot-tool-box") as HTMLElement
      const applyBtn = demo.querySelector(".copilot-apply") as HTMLElement
      const msgs = demo.querySelectorAll(".copilot-msg")
      const tools = demo.querySelectorAll(".copilot-tool")

      progressEl.dataset.stage = "analyzing"
      statusEl.textContent = "Analyzing..."

      msgs[0].classList.add("is-visible")
      await typeText(userMsgEl, userMsg, 10)

      await new Promise((r) => setTimeout(r, 300))

      progressEl.dataset.stage = "generating"
      statusEl.textContent = "Generating..."

      msgs[1].classList.add("is-visible")
      await typeText(responseEl, aiResponse, 15)

      await new Promise((r) => setTimeout(r, 150))
      msgs[2].classList.add("is-visible")
      toolBox.classList.add("is-glowing")

      for (let i = 0; i < tools.length; i++) {
        await new Promise((r) => setTimeout(r, 120))
        const nameEl = tools[i].querySelector(".tool-name") as HTMLElement
        nameEl.textContent = toolNames[i]
        tools[i].classList.add("is-visible", "is-glowing")
        setTimeout(() => tools[i].classList.remove("is-glowing"), 600)
      }

      setTimeout(() => toolBox.classList.remove("is-glowing"), 800)

      await new Promise((r) => setTimeout(r, 250))
      progressEl.dataset.stage = "complete"
      statusEl.textContent = "Complete"
      applyBtn.classList.add("is-ready")

      s.animating = false
      s.done = true
    }

    const playCodeDemo = async () => {
      if (!codeDemo) return
      const s = state.get("code")!
      if (s.done || s.animating) return
      s.animating = true

      const step = codeDemo.closest(".step-animate")
      step?.classList.add("is-visible")

      await new Promise((r) => setTimeout(r, 300))

      const lines = codeDemo.querySelectorAll(".code-line")
      const badge = codeDemo.querySelector(".code-badge")
      const stripeIcon = document.querySelector('.resource-icon[data-resource="stripe"]')
      const importantLines = [3, 4, 6, 11]

      badge?.classList.add("is-glowing")
      setTimeout(() => badge?.classList.remove("is-glowing"), 800)

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i] as HTMLElement
        await new Promise((r) => setTimeout(r, 60))
        line.classList.add("is-visible")

        if (importantLines.includes(i)) {
          line.classList.add("is-highlighting")
          if (i === 4 && stripeIcon) {
            stripeIcon.classList.add("is-active")
            setTimeout(() => stripeIcon.classList.remove("is-active"), 1200)
          }
          setTimeout(() => line.classList.remove("is-highlighting"), 800)
        }
      }

      s.animating = false
      s.done = true
    }

    const playSettingsDemo = async () => {
      if (!settingsDemo) return
      const s = state.get("settings")!
      if (s.done || s.animating) return
      s.animating = true

      const step = settingsDemo.closest(".step-animate")
      step?.classList.add("is-visible")

      await new Promise((r) => setTimeout(r, 300))

      const sections = settingsDemo.querySelectorAll(".settings-section")
      for (let i = 0; i < sections.length; i++) {
        await new Promise((r) => setTimeout(r, 120))
        sections[i].classList.add("is-visible")
      }

      await new Promise((r) => setTimeout(r, 600))

      const gptBtn = settingsDemo.querySelector('.settings-model[data-model="gpt"]') as HTMLElement
      const claudeBtn = settingsDemo.querySelector('.settings-model[data-model="claude"]') as HTMLElement

      if (gptBtn && claudeBtn) {
        claudeBtn.classList.add("is-switching")
        await new Promise((r) => setTimeout(r, 150))
        gptBtn.classList.remove("bg-blue-500/20", "border-blue-500/30", "text-blue-300")
        gptBtn.classList.add("bg-surface-border/50", "border-surface-border", "text-gray-400")
        claudeBtn.classList.remove("is-switching", "bg-surface-border/50", "border-surface-border", "text-gray-400")
        claudeBtn.classList.add("is-selected")
      }

      await new Promise((r) => setTimeout(r, 700))

      const retryApproval = settingsDemo.querySelector('.settings-approval[data-tool="retry"]') as HTMLElement
      const retryBadge = retryApproval?.querySelector(".settings-approval-badge") as HTMLElement

      if (retryApproval && retryBadge) {
        retryApproval.classList.add("is-toggling")
        retryBadge.classList.add("is-changing")
        await new Promise((r) => setTimeout(r, 200))
        retryBadge.classList.remove("bg-amber-500/20", "text-amber-400")
        retryBadge.classList.add("bg-emerald-500/20", "text-emerald-400")
        retryBadge.textContent = "Auto-approve"
        setTimeout(() => {
          retryApproval.classList.remove("is-toggling")
          retryBadge.classList.remove("is-changing")
        }, 400)
      }

      await new Promise((r) => setTimeout(r, 600))

      const version = settingsDemo.querySelector(".settings-version") as HTMLElement
      const deploy = settingsDemo.querySelector(".settings-deploy") as HTMLElement

      if (version) {
        version.textContent = "v1.3.0"
        version.classList.add("is-bumped")
      }
      if (deploy) {
        deploy.classList.add("is-ready")
      }

      s.animating = false
      s.done = true
    }

    const checkSteps = () => {
      const steps = [
        { id: "copilot", el: demo, fn: playCopilotDemo, threshold: 0.25 },
        { id: "code", el: codeDemo, fn: playCodeDemo, threshold: 0.25 },
        { id: "settings", el: settingsDemo, fn: playSettingsDemo, threshold: 0.25 }
      ]

      steps.forEach(({ id, el, fn, threshold }) => {
        if (!el) return
        const s = state.get(id)!
        if (s.done || s.animating) return

        const rect = el.getBoundingClientRect()
        const windowHeight = window.innerHeight

        if (rect.top < windowHeight * (1 - threshold) && rect.bottom > 0) {
          fn()
        }
      })
    }

    let ticking = false
    const handleScroll = () => {
      if (ticking) return
      ticking = true
      requestAnimationFrame(() => {
        checkSteps()
        ticking = false
      })
    }

    const observer = new IntersectionObserver(
      (entries) => {
        if (entries[0].isIntersecting) {
          window.addEventListener("scroll", handleScroll, { passive: true })
          handleScroll()
        }
      },
      { threshold: 0.1 }
    )

    observer.observe(section)
  } else {
    if (demo) {
      const userMsgEl = demo.querySelector(".copilot-user-msg") as HTMLElement
      const responseEl = demo.querySelector(".copilot-response") as HTMLElement
      const progressEl = demo.querySelector(".copilot-progress") as HTMLElement
      const statusEl = demo.querySelector(".copilot-status") as HTMLElement
      const tools = demo.querySelectorAll(".copilot-tool")
      const toolNames = ["getFailedPayments()", "retryPayment(paymentId)", "notifyTeam(message)"]

      userMsgEl.textContent = "Every Monday I waste 30 mins finding failed payments. Automate this."
      responseEl.textContent = "Say less. Here's what I'm building:"
      progressEl.dataset.stage = "complete"
      statusEl.textContent = "Complete"

      demo.querySelectorAll(".copilot-msg").forEach((m) => m.classList.add("is-visible"))
      tools.forEach((t, i) => {
        const nameEl = t.querySelector(".tool-name") as HTMLElement
        nameEl.textContent = toolNames[i]
        t.classList.add("is-visible")
      })
    }

    document.querySelectorAll(".step-animate").forEach((s) => s.classList.add("is-visible"))
    document.querySelectorAll(".code-line").forEach((l) => l.classList.add("is-visible"))
    document.querySelectorAll(".settings-section").forEach((s) => s.classList.add("is-visible"))
  }
</script>
