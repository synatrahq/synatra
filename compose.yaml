include:
  - temporal.yaml

services:
  db:
    image: postgres:18
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: synatra_dev
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - db_data:/var/lib/postgresql
    networks:
      - backend

  redis:
    image: redis:7
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - backend

  server:
    image: node:22-bookworm-slim
    working_dir: /app
    command: >
      sh -c "
        corepack enable &&
        corepack prepare pnpm@10.24.0 --activate &&
        pnpm install --filter @synatra/server... &&
        pnpm --filter @synatra/server dev
      "
    volumes:
      - ./:/app
      - node_modules_server:/app/node_modules
      - pnpm_store:/root/.pnpm-store
    env_file:
      - .env
    environment:
      NODE_ENV: development
      DATABASE_URL: postgres://postgres:postgres@db:5432/synatra_dev
      TEMPORAL_ADDRESS: temporal:7233
      CODE_EXECUTOR_URL: http://code-executor:3001
      RESOURCE_GATEWAY_URL: http://resource-gateway:3000
      SERVICE_SECRET: ${SERVICE_SECRET:-dev-secret-must-be-at-least-32-chars}
      THREAD_STREAM_MODE: ${THREAD_STREAM_MODE:-off}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      NODE_OPTIONS: --max_old_space_size=640
    ports:
      - "8787:8787"
    networks:
      - backend
      - temporal
      - gateway
      - executor
    depends_on:
      db:
        condition: service_healthy
      temporal:
        condition: service_started
      resource-gateway:
        condition: service_started
      code-executor:
        condition: service_started
      redis:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'

  console:
    image: node:22-bookworm-slim
    working_dir: /app
    command: >
      sh -c "
        corepack enable &&
        corepack prepare pnpm@10.24.0 --activate &&
        pnpm install --filter @synatra/console... &&
        pnpm --filter @synatra/console dev -- --host 0.0.0.0
      "
    volumes:
      - ./:/app
      - node_modules_console:/app/node_modules
      - pnpm_store:/root/.pnpm-store
    env_file:
      - .env
    environment:
      VITE_API_BASE: http://localhost:8787
    ports:
      - "5173:5173"
    depends_on:
      server:
        condition: service_started

  # ==========================================================================
  # Worker (Temporal)
  # ==========================================================================
  worker:
    image: node:22-bookworm-slim
    working_dir: /app
    command: >
      sh -c "
        corepack enable &&
        corepack prepare pnpm@10.24.0 --activate &&
        pnpm install --filter @synatra/worker... &&
        pnpm --filter @synatra/worker dev
      "
    volumes:
      - ./:/app
      - node_modules_worker:/app/node_modules
      - pnpm_store:/root/.pnpm-store
    env_file:
      - .env
    environment:
      DATABASE_URL: postgres://postgres:postgres@db:5432/synatra_dev
      TEMPORAL_ADDRESS: temporal:7233
      TEMPORAL_TASK_QUEUE: agent
      CODE_EXECUTOR_URL: http://code-executor:3001
      RESOURCE_GATEWAY_URL: http://resource-gateway:3000
      SERVICE_SECRET: ${SERVICE_SECRET:-dev-secret-must-be-at-least-32-chars}
      THREAD_STREAM_MODE: ${THREAD_STREAM_MODE:-off}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      NODE_OPTIONS: --max_old_space_size=1280
    networks:
      - backend
      - temporal
      - executor
      - gateway
    depends_on:
      db:
        condition: service_healthy
      temporal:
        condition: service_started
      code-executor:
        condition: service_started
      redis:
        condition: service_started
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'

  # ==========================================================================
  # Resource Gateway
  # Centralizes all external resource access (databases, APIs)
  # ==========================================================================
  resource-gateway:
    image: node:22-bookworm-slim
    working_dir: /app
    command: >
      sh -c "
        corepack enable &&
        corepack prepare pnpm@10.24.0 --activate &&
        pnpm install --filter @synatra/resource-gateway... &&
        pnpm --filter @synatra/resource-gateway dev
      "
    volumes:
      - ./:/app
      - node_modules_resource_gateway:/app/node_modules
      - pnpm_store:/root/.pnpm-store
    env_file:
      - .env
    environment:
      DATABASE_URL: postgres://postgres:postgres@db:5432/synatra_dev
      SERVICE_SECRET: ${SERVICE_SECRET:-dev-secret-must-be-at-least-32-chars}
      PORT: "10000"
      INTERNAL_PORT: "3000"
      REDIS_MODE: ${REDIS_MODE:-off}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      NODE_OPTIONS: --max_old_space_size=320
    ports:
      - "3000:3000"
      - "10000:10000"
    networks:
      - backend
      - gateway
      - egress
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # ==========================================================================
  # Code Executor
  # Isolated sandbox for user-defined code execution (uses isolated-vm)
  # ==========================================================================
  code-executor:
    image: node:22-bookworm-slim
    working_dir: /app
    command: >
      sh -c "
        corepack enable &&
        corepack prepare pnpm@10.24.0 --activate &&
        pnpm install --filter @synatra/code-executor... &&
        pnpm --filter @synatra/code-executor dev
      "
    volumes:
      - ./:/app
      - node_modules_code_executor:/app/node_modules
      - pnpm_store:/root/.pnpm-store
    env_file:
      - .env
    environment:
      POOL_SIZE: "4"
      MEMORY_LIMIT_MB: "128"
      QUEUE_LIMIT: "100"
      RESOURCE_GATEWAY_URL: http://resource-gateway:3000
      SERVICE_SECRET: ${SERVICE_SECRET:-dev-secret-must-be-at-least-32-chars}
      NODE_OPTIONS: --max_old_space_size=640
    ports:
      - "3001:3001"
    networks:
      - executor
      - gateway
      - egress
    depends_on:
      resource-gateway:
        condition: service_started
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'
          pids: 100
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=128M,mode=1777,noexec,nosuid,nodev
    security_opt:
      - no-new-privileges:true

networks:
  backend:
  temporal:
  gateway:
    internal: true
  executor:
    internal: true
  egress:

volumes:
  db_data:
  node_modules_server:
  node_modules_console:
  node_modules_worker:
  node_modules_resource_gateway:
  node_modules_code_executor:
  pnpm_store:
